_stapler_update_preset=snap

_snap_name=singularityapp
_snap_channel=stable
_snap_url=https://api.snapcraft.io/api/v1/snaps/download/MGxJGb96XBV8UshTS2iqLOI4ylXW8xwY_127.snap

name=singularityapp
version=12.0.3
release=2
summary="Most powerful chaos management planner"
summary_ru="Бесплатный планировщик задач"
group="Office"
desc="Free your head for inspiration and fresh ideas. 
SingularityApp takes over your routine"
desc_ru="Освободи голову для наблюдений и новых идей.
А для рутины теперь есть SingularityApp."
maintainer="Maxim Slipenko <maks1ms@alt-gnome.ru>"
architectures=("amd64")
homepage="https://singularity-app.ru"
license=("custom")
appstream_app_id='com.singularityapp.SingularityApp'

provides=($name)
conflicts=()

sources_amd64=(
	$_snap_url
	"local:///singularityapp.sh"
)

checksums_amd64=(
	sha256:62b457f1ab70b454a904f3e70db885a7aaaf305e425c39d0902b4c3d1430aa51
	sha256:eb776ec089778a7b04bd78b49be396404b12db85739104262f1bc1262121ddec
)

build_deps=(
	squashfs-tools
	at-spi2-atk
	libXcomposite
	libXdamage
	libXext
	libXfixes
	libXrandr
	libalsa
	libat-spi2-core
	libatk
	libcairo
	libcups
	libdbus
	libdbusmenu
	libdbusmenu-gtk3
	libdrm
	libgbm
	libgdk-pixbuf
	libgio
	libgtk+3
	libnspr
	libnss
	libpango
	libsqlite3
	libsystemd
	libxkbcommon
)

deps=(
	firejail
)

nonfree=1
nonfree_url='https://singularity-app.ru/terms_of_service/'

firejailed=1
firejail_profiles=(
	['default']='firejail.profile'
)

auto_req=1
auto_req_skiplist=(
	"/opt/singularityapp/usr/lib/x86_64-linux-gnu/libappindicator3.so.1.0.0"
)

prepare() {
	unsquashfs "${srcdir}/"*.snap
}

package() {
	mkdir -p "${pkgdir}/usr/share/pixmaps/"
	mkdir -p "${pkgdir}/usr/share/applications/"
	mkdir -p "${pkgdir}/opt/${name}"
	mkdir -p "${pkgdir}/usr/bin/"

	install ${srcdir}/squashfs-root/meta/gui/icon.png "${pkgdir}/usr/share/pixmaps/$name.png"
	install ${srcdir}/squashfs-root/meta/gui/*.desktop "${pkgdir}/usr/share/applications/$name.desktop"

	mv "${srcdir}/squashfs-root/"* "${pkgdir}/opt/${name}"

	subst "s|^Icon=.*|Icon=$name|" "${pkgdir}/usr/share/applications/$name.desktop"
	subst "s|^Comment=$|Comment=$summary|" "${pkgdir}/usr/share/applications/$name.desktop"

	install-binary "singularityapp.sh" "${name}"
}

files() {
	files-find \
		"/opt/${name}/**/*" \
		"/usr/bin/$name" \
		"/usr/share/pixmaps/$name.png" \
		"/usr/share/applications/$name.desktop"
}

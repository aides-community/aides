sfe_249_new_extractor=1

name=yandex-browser-stable
version=25.12.1.1217
release=3
summary="The web browser from Yandex"
group="Networking/WWW"
desc="$summary.

Yandex Browser is a browser that combines a minimal design with sophisticated technology to make the web faster, safer, and easier."
summary_ru="Веб-браузер от Яндекса"
desc_ru="$summary_ru.

Яндекс Браузер - это браузер, который сочетает в себе минималистичный дизайн со сложными технологиями, чтобы сделать работу в Интернете быстрее, безопаснее и проще."
maintainer="Maxim Slipenko <maks1ms@alt-gnome.ru>"
architectures=("amd64")
homepage="https://browser.yandex.ru/"
license=("custom")
appstream_app_id='ru.yandex.Browser'
nonfree=1
nonfree_url="https://yandex.ru/legal/browser_agreement/ru/"

_pkgver=$version-1
_pkgname=browser-stable

provides=(
	yandex-browser
	webclient
)
conflicts=(
	yandex-browser-beta
	yandex-browser-corporate
)

build_deps=(
	binutils
	tar

	# for update_codecs
	wget
	squashfs-tools
	glibc-pthread
)

auto_reqprov_method=dirty
auto_req=1
auto_prov=1

firejailed=1
firejail_profiles=(
	['default']='aides-yandex-browser-stable-bundled.profile'
)

sources=(
	"https://repo.yandex.ru/yandex-browser/deb/pool/main/y/yandex-${_pkgname}/yandex-${_pkgname}_${_pkgver}_amd64.deb?~name=${name}-${_pkgver}.deb"
)
checksums=(
	sha256:a8dcbabdb643b3289728d0a26a2812a18467991ec1082adff6d92e9ce59b7ced
)

prepare() {
	if [ -f "${name}-${_pkgver}.deb" ]; then
		echo "Using ar extraction"
		ar x ${name}-${_pkgver}.deb
	else
		echo "deb already extracted"
	fi
	tar -xf data.tar.xz
}

package() {
	cp -dr opt usr "${pkgdir}"/
	# Menu entry /usr/share/menu/yandex-browser.menu skipped: obsolete format
	rm -f "${pkgdir}"/usr/share/menu/yandex-browser.menu
	install -Dm 0644 "${pkgdir}"/opt/yandex/browser/product_logo_128.png "${pkgdir}"/usr/share/pixmaps/yandex-browser.png

	sed -i 's|export CHROME_WRAPPER="`readlink -f "$0"`"|export CHROME_WRAPPER=/usr/bin/yandex-browser-stable|' "${pkgdir}"/opt/yandex/browser/yandex-browser
	sed -i 's|HERE="`dirname "$CHROME_WRAPPER"`"|HERE=/opt/yandex/browser|' "${pkgdir}"/opt/yandex/browser/yandex-browser

	"${pkgdir}"/opt/yandex/browser/update_codecs "${pkgdir}"/opt/yandex/browser
}

files() {
	files-find-binary yandex-browser-stable
	files-find-doc yandex-browser-stable
	files-find-desktop ru.yandex.desktop.browser.desktop yandex-browser.desktop
	files-find-pixmap yandex-browser.png

	files-find \
		"/opt/yandex/**/*" \
		"/usr/share/appdata/*" \
		"/usr/share/gnome-control-center/default-apps/*"
}

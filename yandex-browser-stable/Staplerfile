name=yandex-browser-stable
version=25.10.1.1173
release=1
summary="The web browser from Yandex"
group="Networking/WWW"
desc="The web browser from Yandex

Yandex Browser is a browser that combines a minimal design with sophisticated technology to make the web faster, safer, and easier."
maintainer="Maxim Slipenko <maks1ms@alt-gnome.ru>"
architectures=("amd64")
homepage="https://browser.yandex.ru/"
license=("custom")

nonfree=1
nonfree_url="https://yandex.ru/legal/browser_agreement/ru/"

_pkgver=$version-1
_pkgname=browser-stable

provides=(
	yandex-browser
	webclient
)
conflicts=(
	yandex-browser-beta
	yandex-browser-corporate
)

build_deps=(
	binutils
	tar

	# for update_codecs
	wget
	squashfs-tools
	glibc-pthread
)

auto_reqprov_method=dirty
auto_req=1
auto_prov=1

firejailed=1
firejail_profiles=(
	['default']='aides-yandex-browser-bundled.profile'
)

sources=(
	"https://repo.yandex.ru/yandex-browser/deb/pool/main/y/yandex-${_pkgname}/yandex-${_pkgname}_${_pkgver}_amd64.deb?~name=${name}-${_pkgver}.deb"
)
checksums=(
	sha256:31ec155f50ba0ec9c4d4841322ead9b196429926ededaee0c4c9b4caa937aa64
)

prepare() {
	ar x ${name}-${_pkgver}.deb
	tar -xf data.tar.xz
}

package() {
	cp -dr opt usr "${pkgdir}"/
	# Menu entry /usr/share/menu/yandex-browser.menu skipped: obsolete format
	rm -f "${pkgdir}"/usr/share/menu/yandex-browser.menu
	install -Dm 0644 "${pkgdir}"/opt/yandex/browser/product_logo_128.png "${pkgdir}"/usr/share/pixmaps/yandex-browser.png

	sed -i 's|export CHROME_WRAPPER="`readlink -f "$0"`"|export CHROME_WRAPPER=/usr/bin/yandex-browser-stable|' "${pkgdir}"/opt/yandex/browser/yandex-browser
	sed -i 's|HERE="`dirname "$CHROME_WRAPPER"`"|HERE=/opt/yandex/browser|' "${pkgdir}"/opt/yandex/browser/yandex-browser

	"${pkgdir}"/opt/yandex/browser/update_codecs "${pkgdir}"/opt/yandex/browser
}

files() {
	files-find \
		"/opt/yandex/**/*" \
		"/usr/bin/yandex-browser-stable" \
		"/usr/share/appdata/*" \
		"/usr/share/applications/*" \
		"/usr/share/gnome-control-center/default-apps/*" \
		"/usr/share/pixmaps/*"

	files-find-doc yandex-browser-stable
}
